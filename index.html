<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAMNED RPG - V31</title>
    <style>
        :root { --bg-body: #0d0b12; --bg-header: #161222; --bg-card: #1f1a2e; --bg-input: #1f1a2e; --border-color: #3d2a5c; --accent-color: #7a4cff; --text-main: #eee; --text-dim: #aaa; }
        [data-theme="light"] { --bg-body: #e8d5b5; --bg-header: #d4bc93; --bg-card: #f4e4c1; --bg-input: #fffdf5; --border-color: #a68b5a; --accent-color: #8b4513; --text-main: #2b1d0e; --text-dim: #5c4033; }
        [data-theme="vampire"] { --bg-body: #0f0a0a; --bg-header: #1a0f0f; --bg-card: #261414; --bg-input: #1a0f0f; --border-color: #5c1414; --accent-color: #e61919; --text-main: #f2e6e6; --text-dim: #a68585; }
        [data-theme="forest"] { --bg-body: #1a1f16; --bg-header: #262e20; --bg-card: #343d2c; --bg-input: #262e20; --border-color: #4a5c3d; --accent-color: #8db35d; --text-main: #e8f0e0; --text-dim: #99a68d; }
        [data-theme="cyber"] { --bg-body: #050505; --bg-header: #0a0a0f; --bg-card: #10101a; --bg-input: #0a0a0f; --border-color: #00f2ff; --accent-color: #00f2ff; --text-main: #fff; --text-dim: #00ccff; }

        body { margin:0; font-family:Arial, sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 80px; transition: 0.3s; overflow-x: hidden; }

        /* LOADING */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050508; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; }
        .loader-logo { width: 50px; height: 50px; border: 4px solid var(--accent-color); border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* SIDEBAR */
        #sidebar { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: var(--bg-header); z-index: 10001; transition: 0.3s; border-right: 2px solid var(--accent-color); padding: 20px; box-sizing: border-box; }
        #sidebar.open { left: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; }
        #btn-menu-global { position: fixed; top: 15px; left: 15px; font-size: 24px; background: rgba(0,0,0,0.7); border: 1px solid var(--accent-color); border-radius: 8px; color: var(--accent-color); cursor: pointer; z-index: 9500; width: 45px; height: 45px; display: none; align-items: center; justify-content: center; }

        /* MENU SELE√á√ÉO */
        #menu-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://files.catbox.moe/o5f62o.png') no-repeat center center; background-size: cover; z-index: 9000; padding: 20px; box-sizing: border-box; display: none; overflow-y: auto; }
        .char-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px 0 60px; }
        .char-card { background: rgba(0,0,0,0.85); border: 1px solid var(--accent-color); border-radius: 12px; padding: 10px; text-align: center; }
        .char-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; }

        /* FICHA */
        #sheet-content { display: none; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        header { display:flex; gap:10px; padding: 15px; background: var(--bg-header); border-bottom: 2px solid var(--border-color); position: relative; }
        header img { width: 90px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid var(--accent-color); cursor: pointer; }
        .header-info { flex:1; }
        .header-info input { width:100%; margin-bottom:5px; padding:6px; border-radius:6px; border:none; background: var(--bg-input); color: #fff; font-size: 11px; }

        .tabs { display:flex; background: var(--bg-header); overflow-x: auto; position: sticky; top:0; z-index:10; border-bottom: 1px solid var(--border-color); scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tabs button { flex:none; padding:15px; background:none; border:none; color: var(--text-dim); font-size:10px; font-weight: bold; cursor:pointer; text-transform: uppercase; }
        .tabs button.active { color: var(--accent-color); border-bottom:3px solid var(--accent-color); }

        .section { display:none; padding:15px; }
        .section.active { display:block; }

        .bar-block { background: var(--bg-header); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 12px; }
        .bar { height:12px; background: #000; border-radius:10px; overflow:hidden; margin: 8px 0; border: 1px solid #111; }
        .bar-fill { height:100%; transition: 0.5s; }
        .bar-controls { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
        .bar-controls button { padding: 5px 8px; border-radius: 4px; border: none; background: var(--border-color); color: #fff; font-size: 10px; cursor: pointer; }

        .input-group { background: var(--bg-header); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-input); color: #fff; margin-bottom: 8px; box-sizing: border-box; }
        .list-item { background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--accent-color); position: relative; }
        .list-item b { cursor: pointer; display: block; color: var(--accent-color); }
        .list-item small { cursor: pointer; color: var(--text-dim); display: block; margin-top: 4px; font-size: 12px; }
        .btn-del { position: absolute; top: 8px; right: 8px; background: #c00; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px; }

        .diario-container { display: flex; flex-direction: column; gap: 15px; }
        .diario-label { font-size: 12px; font-weight: bold; color: var(--accent-color); margin-bottom: 5px; text-transform: uppercase; }

        .footer-tools { position: fixed; bottom: 0; width: 100%; background: var(--bg-header); padding: 12px; display: flex; gap: 10px; border-top: 2px solid var(--border-color); box-sizing: border-box; }
        .footer-tools button { flex: 1; padding: 12px; border-radius: 8px; border: none; color: #fff; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body data-theme="dark">

<button id="btn-menu-global" onclick="toggleSidebar()">‚ò∞</button>

<div id="sidebar">
    <h3 style="color: var(--accent-color)">Op√ß√µes</h3>
    <div style="padding: 15px 0; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="cycleTheme()">üåì Trocar Tema</div>
    <div style="padding: 15px 0; color: #ff4c4c; cursor: pointer;" onclick="toggleSidebar()">‚úñ Fechar</div>
</div>
<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

<div id="loading-screen"><div class="loader-logo"></div></div>

<div id="menu-screen">
    <h1 style="text-align:center; color:#fff; margin-top:50px; text-shadow: 0 0 15px var(--accent-color); letter-spacing: 4px;">DAMNED RPG</h1>
    <button onclick="novoPersonagem()" style="width:100%; padding:18px; background:var(--accent-color); color:#fff; border:none; border-radius:12px; font-weight:bold; cursor:pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">+ NOVA LENDA</button>
    <div id="lista-personagens" class="char-grid"></div>
</div>

<div id="sheet-content">
    <header>
        <button onclick="abrirMenu()" style="position:absolute; top:10px; right:10px; background:#8b0000; border:none; color:#fff; padding:6px 12px; border-radius:5px; font-size:10px; font-weight:bold;">SAIR</button>
        <img id="imgChar" onclick="document.getElementById('fileInput').click()" src="https://via.placeholder.com/100x130">
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadImagem(event)">
        <div class="header-info">
            <input id="nome" placeholder="Nome" onchange="salvarHeader()">
            <input id="idade" placeholder="Idade" onchange="salvarHeader()">
            <input id="raca" placeholder="Ra√ßa" onchange="salvarHeader()">
            <input id="classe" placeholder="Classe" onchange="salvarHeader()">
        </div>
    </header>

    <div class="tabs">
        <button data-tab="0" class="tab-btn active">Status</button>
        <button data-tab="1" class="tab-btn">Atribs</button>
        <button data-tab="2" class="tab-btn">Poderes</button>
        <button data-tab="3" class="tab-btn">Armas</button>
        <button data-tab="4" class="tab-btn">Defesa</button>
        <button data-tab="5" class="tab-btn">Invent√°rio</button>
        <button data-tab="6" class="tab-btn">Penit</button>
        <button data-tab="7" class="tab-btn">Di√°rio</button>
    </div>

    <div class="section active" data-sec="0" id="status-container"></div>
    
    <div class="section" data-sec="1">
        <div class="input-group"><input id="atN" placeholder="Atributo"><input id="atV" type="number" placeholder="Valor"><button onclick="addAtributo()" style="width:100%; background:var(--accent-color); border:none; padding:10px; color:#fff; border-radius:6px;">ADICIONAR</button></div>
        <div id="listaAt"></div>
    </div>

    <div class="section" data-sec="2">
        <div class="input-group"><input id="pdN" placeholder="Poder"><textarea id="pdD" placeholder="Descri√ß√£o"></textarea><button onclick="addItem('habilidades',['pdN','pdD'],['n','d'])" style="width:100%; background:var(--accent-color); border:none; padding:10px; color:#fff; border-radius:6px;">ADICIONAR</button></div>
        <div id="listaPd"></div>
    </div>

    <div class="section" data-sec="3">
        <div class="input-group"><input id="arN" placeholder="Arma"><input id="arDan" placeholder="Dano"><textarea id="arD" placeholder="Efeitos"></textarea><button onclick="addItem('armas',['arN','arDan','arD'],['n','dan','d'])" style="width:100%; background:var(--accent-color); border:none; padding:10px; color:#fff; border-radius:6px;">ADICIONAR</button></div>
        <div id="listaAr"></div>
    </div>

    <div class="section" data-sec="4">
        <div style="text-align:center; padding:15px; border:1px solid var(--accent-color); border-radius:10px; margin-bottom:15px;">DEFESA TOTAL: <b id="defTotal" style="color:var(--accent-color); font-size:20px;">0</b></div>
        <div class="input-group"><input id="eqN" placeholder="Equipamento"><input id="eqV" type="number" placeholder="Valor Defesa"><button onclick="addItem('equipamentos',['eqN','eqV'],['n','v'])" style="width:100%; background:var(--accent-color); border:none; padding:10px; color:#fff; border-radius:6px;">ADICIONAR</button></div>
        <div id="listaEq"></div>
    </div>

    <div class="section" data-sec="5">
        <div class="input-group"><input id="invN" placeholder="Item do Invent√°rio"><input id="invQ" placeholder="Quantidade"><textarea id="invD" placeholder="Detalhes"></textarea><button onclick="addItem('inventario',['invN','invQ','invD'],['n','q','d'])" style="width:100%; background:var(--accent-color); border:none; padding:10px; color:#fff; border-radius:6px;">ADICIONAR</button></div>
        <div id="listaInv"></div>
    </div>

    <div class="section" data-sec="6">
        <div class="input-group"><input id="peN" placeholder="Penit√™ncia"><textarea id="peD" placeholder="Efeito"></textarea><button onclick="addItem('penitencias',['peN','peD'],['n','d'])" style="width:100%; background:var(--accent-color); border:none; padding:10px; color:#fff; border-radius:6px;">ADICIONAR</button></div>
        <div id="listaPe"></div>
    </div>

    <div class="section" data-sec="7">
        <div class="diario-container">
            <div>
                <div class="diario-label">üìú Hist√≥ria do Personagem</div>
                <textarea id="historia" style="height:180px;" placeholder="Conte a origem da sua lenda..." onchange="salvarDiario()"></textarea>
            </div>
            <div>
                <div class="diario-label">üìù Anota√ß√µes da Campanha</div>
                <textarea id="anotacoes" style="height:220px;" placeholder="Registre os fatos importantes das sess√µes..." onchange="salvarDiario()"></textarea>
            </div>
        </div>
    </div>

    <div class="footer-tools">
        <button onclick="desfazer()" style="background:#444;">‚Ü© VOLTAR</button>
        <button onclick="refazer()" style="background:#555;">AVAN√áAR ‚Ü™</button>
    </div>
</div>

<script>
let db = JSON.parse(localStorage.getItem('RPG_DB_V31')) || [];
let cur = -1; let ficha = {}; let undo = []; let redo = [];
const temas = ['dark', 'light', 'vampire', 'forest', 'cyber'];

function cycleTheme() {
    let a = document.body.getAttribute('data-theme') || 'dark';
    let p = temas[(temas.indexOf(a) + 1) % temas.length];
    document.body.setAttribute('data-theme', p);
    localStorage.setItem('RPG_THEME', p);
}

function toggleSidebar() {
    const s = document.getElementById('sidebar'), o = document.getElementById('overlay');
    s.classList.toggle('open'); o.style.display = s.classList.contains('open') ? 'block' : 'none';
}

function iniciar() {
    document.body.setAttribute('data-theme', localStorage.getItem('RPG_THEME') || 'dark');
    setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; abrirMenu(); }, 1000);
}

function abrirMenu() {
    cur = -1;
    document.getElementById('sheet-content').style.display = 'none';
    document.getElementById('btn-menu-global').style.display = 'flex';
    document.getElementById('menu-screen').style.display = 'block';
    renderLista();
}

function renderLista() {
    const l = document.getElementById('lista-personagens'); l.innerHTML = '';
    db.forEach((c, i) => {
        const d = document.createElement('div'); d.className = 'char-card';
        d.onclick = () => selecionar(i);
        d.innerHTML = `<img src="${c.img || 'https://via.placeholder.com/100'}"><h3>${c.nome}</h3><button onclick="event.stopPropagation(); apagar(${i})" style="background:#600; color:#fff; border:none; width:100%; padding:5px; border-radius:4px; font-size:10px;">APAGAR</button>`;
        l.appendChild(d);
    });
}

function selecionar(i) {
    cur = i; ficha = JSON.parse(JSON.stringify(db[i]));
    if(!ficha.inventario) ficha.inventario = [];
    if(!ficha.historia) ficha.historia = "";
    if(!ficha.anotacoes) ficha.anotacoes = "";
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('btn-menu-global').style.display = 'none';
    document.getElementById('sheet-content').style.display = 'block';
    render();
}

function novoPersonagem() {
    const n = { nome: 'Novo Her√≥i', idade: '', raca: '', classe: '', img: '', pv: 10, pvMax: 10, pe: 10, peMax: 10, arc: 0, arcMax: 10, ocu: 0, ocuMax: 10, vin: 0, vinMax: 10, corr: 0, corrMax: 10, atributos: {}, habilidades: [], armas: [], equipamentos: [], inventario: [], penitencias: [], historia: '', anotacoes: '' };
    db.push(n); salvarBD(); renderLista();
}

function apagar(i) { if(confirm("Apagar?")) { db.splice(i, 1); salvarBD(); renderLista(); } }
function salvarBD() { if(cur !== -1) db[cur] = JSON.parse(JSON.stringify(ficha)); localStorage.setItem('RPG_DB_V31', JSON.stringify(db)); }
function snap() { undo.push(JSON.stringify(ficha)); redo = []; if(undo.length > 20) undo.shift(); }

function uploadImagem(event) {
    const r = new FileReader(); r.onload = (e) => { snap(); ficha.img = e.target.result; render(); };
    r.readAsDataURL(event.target.files[0]);
}

function editarTexto(key, index, field, msg) {
    let valorAtual;
    if (key === 'at') { valorAtual = field === 'nome' ? index : ficha.atributos[index]; } 
    else { valorAtual = ficha[key][index][field]; }

    let novoValor = prompt(msg, valorAtual);
    if (novoValor !== null && novoValor.trim() !== "") {
        snap();
        if (key === 'at') {
            if (field === 'nome') {
                let tempVal = ficha.atributos[index];
                delete ficha.atributos[index];
                ficha.atributos[novoValor] = tempVal;
            } else { ficha.atributos[index] = novoValor; }
        } else { ficha[key][index][field] = novoValor; }
        render();
    }
}

function modV(t, q) { snap(); ficha[t] += q; if(ficha[t] < 0) ficha[t] = 0; render(); }
function setM(t, v) { snap(); ficha[t+'Max'] = parseInt(v) || 1; render(); }

function addAtributo() {
    const n = document.getElementById('atN').value, v = document.getElementById('atV').value;
    if(!n) return; snap(); ficha.atributos[n] = v;
    document.getElementById('atN').value = ''; document.getElementById('atV').value = ''; render();
}

function addItem(key, ids, keys) {
    const vals = ids.map(id => document.getElementById(id).value); if(!vals[0]) return;
    snap(); let o = {}; keys.forEach((k, i) => o[k] = vals[i]);
    ficha[key].push(o); ids.forEach(id => document.getElementById(id).value = ''); render();
}

function remI(k, i) { snap(); if(k==='at') delete ficha.atributos[i]; else ficha[k].splice(i,1); render(); }
function salvarDiario() { ficha.historia = document.getElementById('historia').value; ficha.anotacoes = document.getElementById('anotacoes').value; salvarBD(); }
function salvarHeader() { 
    ficha.nome = document.getElementById('nome').value; ficha.idade = document.getElementById('idade').value;
    ficha.raca = document.getElementById('raca').value; ficha.classe = document.getElementById('classe').value;
    salvarBD();
}

function render() {
    const cont = document.getElementById('status-container'); cont.innerHTML = '';
    const st = [{id:'pv', n:'Vida', c:'#c00'}, {id:'pe', n:'Energia', c:'#00c'}, {id:'arc', n:'Arcano', c:'#808'}, {id:'ocu', n:'Ocultismo', c:'#060'}, {id:'vin', n:'V√≠nculo', c:'#a50'}, {id:'corr', n:'Corrup√ß√£o', c:'#444'}];
    st.forEach(s => {
        const p = (ficha[s.id] / ficha[s.id+'Max']) * 100;
        cont.innerHTML += `<div class="bar-block">
            <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold;"><span>${s.n}</span><span>${ficha[s.id]}/${ficha[s.id+'Max']}</span></div>
            <div class="bar"><div class="bar-fill" style="width:${Math.min(100, p)}%; background:${s.c}"></div></div>
            <div class="bar-controls">
                <button onclick="modV('${s.id}',-5)">-5</button><button onclick="modV('${s.id}',-1)">-1</button>
                <button onclick="modV('${s.id}',1)">+1</button><button onclick="modV('${s.id}',5)">+5</button>
                <input type="number" value="${ficha[s.id+'Max']}" onchange="setM('${s.id}',this.value)" style="width:45px; padding:3px; font-size:10px;">
            </div>
        </div>`;
    });

    document.getElementById('nome').value = ficha.nome;
    document.getElementById('idade').value = ficha.idade;
    document.getElementById('raca').value = ficha.raca;
    document.getElementById('classe').value = ficha.classe;
    document.getElementById('imgChar').src = ficha.img || 'https://via.placeholder.com/100x130';
    document.getElementById('historia').value = ficha.historia || '';
    document.getElementById('anotacoes').value = ficha.anotacoes || '';

    const rl = (id, list, key, temp) => {
        const el = document.getElementById(id); el.innerHTML = '';
        if(key === 'at') Object.keys(list).forEach(k => el.innerHTML += temp(k, list[k]));
        else list.forEach((it, i) => el.innerHTML += temp(it, i));
    };

    rl('listaAt', ficha.atributos, 'at', (k, v) => `<div class="list-item"><b onclick="editarTexto('at','${k}','nome','Novo nome do atributo:')">${k}:</b> <small onclick="editarTexto('at','${k}','valor','Novo valor:')">${v}</small><button class="btn-del" onclick="remI('at','${k}')">X</button></div>`);
    rl('listaPd', ficha.habilidades, 'h', (it, i) => `<div class="list-item"><b onclick="editarTexto('habilidades',${i},'n','Novo nome do poder:')">${it.n}</b><small onclick="editarTexto('habilidades',${i},'d','Nova descri√ß√£o:')">${it.d}</small><button class="btn-del" onclick="remI('habilidades',${i})">X</button></div>`);
    rl('listaAr', ficha.armas, 'a', (it, i) => `<div class="list-item"><b onclick="editarTexto('armas',${i},'n','Novo nome da arma:')">${it.n}</b><small onclick="editarTexto('armas',${i},'dan','Novo dano (ex: 1d10):')">Dano: ${it.dan}</small><small onclick="editarTexto('armas',${i},'d','Novos efeitos:')">${it.d}</small><button class="btn-del" onclick="remI('armas',${i})">X</button></div>`);
    rl('listaPe', ficha.penitencias, 'p', (it, i) => `<div class="list-item"><b onclick="editarTexto('penitencias',${i},'n','Novo nome:')">${it.n}</b><small onclick="editarTexto('penitencias',${i},'d','Novo efeito:')">${it.d}</small><button class="btn-del" onclick="remI('penitencias',${i})">X</button></div>`);
    rl('listaInv', ficha.inventario, 'inv', (it, i) => `<div class="list-item"><b onclick="editarTexto('inventario',${i},'n','Novo nome:')">${it.n}</b><small onclick="editarTexto('inventario',${i},'q','Nova quantidade:')">Qtd: ${it.q}</small><small onclick="editarTexto('inventario',${i},'d','Novos detalhes:')">${it.d}</small><button class="btn-del" onclick="remI('inventario',${i})">X</button></div>`);

    let def = 0;
    rl('listaEq', ficha.equipamentos, 'e', (it, i) => { 
        def += parseInt(it.v) || 0; 
        return `<div class="list-item"><b onclick="editarTexto('equipamentos',${i},'n','Novo nome:')">${it.n}</b><small onclick="editarTexto('equipamentos',${i},'v','Novo valor de defesa:')">+${it.v} Def</small><button class="btn-del" onclick="remI('equipamentos',${i})">X</button></div>`;
    });
    document.getElementById('defTotal').innerText = def;
    salvarBD();
}

function desfazer() { if(undo.length > 0) { redo.push(JSON.stringify(ficha)); ficha = JSON.parse(undo.pop()); render(); } }
function refazer() { if(redo.length > 0) { undo.push(JSON.stringify(ficha)); ficha = JSON.parse(redo.pop()); render(); } }

window.onload = () => {
    iniciar();
    document.querySelectorAll('.tab-btn').forEach(b => b.onclick = () => {
        document.querySelectorAll('.tab-btn, .section').forEach(e => e.classList.remove('active'));
        b.classList.add('active'); document.querySelector(`.section[data-sec="${b.dataset.tab}"]`).classList.add('active');
    });
};
</script>
</body>
</html>
