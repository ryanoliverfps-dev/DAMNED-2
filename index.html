<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha RPG – Anime Medieval</title>
    <style>
        body{margin:0;font-family:Arial, sans-serif;background:#0d0b12;color:#eee; padding-bottom: 80px;}
        header{display:flex;gap:10px;padding:15px;background:#161222;border-bottom: 2px solid #3d2a5c;}
        header img{width:120px;height:160px;object-fit:cover;border-radius:10px;border:2px solid #3d2a5c;background:#000;cursor:pointer}
        .header-info{flex:1}
        .header-info input{width:100%;margin-bottom:6px;padding:8px;border-radius:6px;border:none;background:#1f1a2e;color:#fff;box-sizing:border-box}
        
        .tabs{display:flex;background:#161222;overflow-x: auto; position: sticky; top:0; z-index:10; border-bottom: 1px solid #3d2a5c;}
        .tabs button{flex:1;padding:15px;background:none;border:none;color:#aaa;font-size:11px;cursor:pointer;white-space: nowrap; text-transform: uppercase; font-weight: bold;}
        .tabs button.active{color:#fff;border-bottom:3px solid #7a4cff;background:#1f1a2e}
        
        .section{display:none;padding:15px;animation: fadeIn 0.3s;}
        .section.active{display:block}
        
        .bar-block{margin-bottom:15px; background: #161222; padding: 12px; border-radius: 8px; border: 1px solid #2a2438;}
        .bar-info{display:flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 14px;}
        .bar{height:14px;background:#2a2438;border-radius:7px;overflow:hidden;margin: 8px 0; border: 1px solid #000;}
        .bar-fill{height:100%;width:0%;transition: width 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67);}
        
        #pvBar{background: linear-gradient(90deg, #8b0000, #ff4c4c);}
        #peBar{background: linear-gradient(90deg, #002db3, #4c7aff);}
        #arcBar{background: linear-gradient(90deg, #4b0082, #9370db);}
        #ocuBar{background: linear-gradient(90deg, #222, #555);}
        #vinBar{background: linear-gradient(90deg, #1d5c2d, #4cff77);}
        #corrBar{background: linear-gradient(90deg, #4a1d5c, #a34cff);}

        .bar-controls{display:flex; align-items: center; gap:5px; margin-top:10px; flex-wrap: wrap;}
        .bar-controls input { width: 55px; background: #0b090f; color: #fff; border: 1px solid #3d2a5c; border-radius: 4px; padding: 5px; font-size: 12px;}
        
        .input-group{margin-bottom: 15px; background: #161222; padding: 15px; border-radius: 8px;}
        .input-group label { display: block; margin-bottom: 8px; color: #7a4cff; font-weight: bold; font-size: 14px; }
        
        input, textarea, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #3d2a5c; background: #1f1a2e; color: #fff; box-sizing: border-box; margin-bottom: 10px; }
        
        button{background:#3d2a5c;color:#fff;border:none;border-radius:6px;padding:8px 10px;cursor:pointer; font-size: 13px;}
        button:hover{background:#7a4cff}
        .btn-big{background: #2a2a5c; font-weight: bold;}
        
        .footer-tools{position: fixed; bottom: 0; width: 100%; background: #161222; padding: 10px; display: flex; justify-content: center; border-top: 1px solid #3d2a5c; z-index: 100;}
        .btn-undo{background: #5c5c2a; font-weight: bold; width: 80%;}

        .list-item{background:#1f1a2e;padding:12px;border-radius:6px;margin:8px 0;border-left:4px solid #7a4cff; overflow: hidden; position: relative;}
        .btn-delete{background: #8b0000; padding: 4px 8px; font-size: 11px; float: right; margin-left: 5px;}
        
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    </style>
</head>
<body>

<header>
    <img id="imgChar" src="https://via.placeholder.com/120x160?text=Avatar" onclick="trocarImagem()">
    <div class="header-info">
        <input id="nome" placeholder="Nome" onchange="salvarHeader()">
        <input id="idade" placeholder="Idade" onchange="salvarHeader()">
        <input id="raca" placeholder="Raça" onchange="salvarHeader()">
        <input id="classe" placeholder="Classe" onchange="salvarHeader()">
    </div>
</header>

<div class="tabs">
    <button data-tab="0" class="tab-btn active">Status</button>
    <button data-tab="1" class="tab-btn">Atributos</button>
    <button data-tab="2" class="tab-btn">Poderes</button>
    <button data-tab="4" class="tab-btn">Equip</button>
    <button data-tab="6" class="tab-btn">Penitência</button>
    <button data-tab="7" class="tab-btn">Diário</button>
</div>

<div class="section active" data-sec="0">
    <div id="status-container"></div>
</div>

<div class="section" data-sec="1">
    <div class="input-group">
        <input id="attrNome" placeholder="Nome (ex: Força)">
        <input id="attrValor" type="number" placeholder="Valor">
        <button onclick="addAtributo()" style="width:100%">Adicionar Atributo</button>
    </div>
    <div id="listaAtributos"></div>
</div>

<div class="section" data-sec="2">
    <div class="input-group">
        <input id="habNome" placeholder="Nome do Poder">
        <textarea id="habDesc" placeholder="Descrição..."></textarea>
        <button onclick="addHabilidade()" style="width:100%">Adicionar Poder</button>
    </div>
    <div id="listaHabilidades"></div>
</div>

<div class="section" data-sec="4">
    <div class="input-group">
        <label>Defesa Atual</label>
        <input id="armDef" type="number" placeholder="Defesa Total" onchange="salvarSimples()">
    </div>
    <div class="input-group">
        <input id="armaNome" placeholder="Nome da Arma/Item">
        <input id="armaDano" placeholder="Dano / Efeito">
        <button onclick="addArma()" style="width:100%">Adicionar Item</button>
    </div>
    <div id="listaArmas"></div>
</div>

<div class="section" data-sec="6">
    <div class="input-group">
        <input id="penNome" placeholder="Nome da Penitência">
        <input id="penLV" type="number" placeholder="Nível">
        <textarea id="penDesc" placeholder="Descrição do fardo..."></textarea>
        <button onclick="addPenitencia()" style="width:100%">Adicionar Penitência</button>
    </div>
    <div id="listaPenitencias"></div>
</div>

<div class="section" data-sec="7">
    <div class="input-group">
        <label>História do Personagem</label>
        <textarea id="historia" style="height: 200px;" onchange="salvarSimples()" placeholder="Era uma vez..."></textarea>
    </div>
    <div class="input-group">
        <label>Anotações Gerais</label>
        <textarea id="notas" style="height: 200px;" onchange="salvarSimples()" placeholder="Missões..."></textarea>
    </div>
</div>

<div class="footer-tools">
    <button class="btn-undo" onclick="desfazer()">↩ DESFAZER ÚLTIMA AÇÃO</button>
</div>

<script>
let ficha = {
    nome: '', idade: '', raca: '', classe: '', img: '',
    pv: 10, pvMax: 10, pe: 10, peMax: 10, arc: 0, arcMax: 10, ocu: 0, ocuMax: 10, 
    vin: 0, vinMax: 10, corr: 0, corrMax: 10,
    atributos: {}, habilidades: [], armas: [], penitencias: [],
    defesa: 0, historia: '', notas: ''
};

const statusConfig = [
    {id: 'pv', label: 'Vida (PV)'},
    {id: 'pe', label: 'Energia (PE)'},
    {id: 'arc', label: 'C. Arcano'},
    {id: 'ocu', label: 'Ocultismo'},
    {id: 'vin', label: 'Vínculo'},
    {id: 'corr', label: 'Corrupção'}
];

let historico = [];

function snapshot() {
    if (historico.length > 20) historico.shift();
    historico.push(JSON.stringify(ficha));
}

function salvar(){ 
    localStorage.setItem('fichaRPG_V7', JSON.stringify(ficha)); 
    render();
}

function renderStatus() {
    const container = document.getElementById('status-container');
    container.innerHTML = '';
    statusConfig.forEach(s => {
        container.innerHTML += `
        <div class="bar-block">
            <div class="bar-info"><span>${s.label}</span><span id="${s.id}Txt">0 / 0</span></div>
            <div class="bar"><div id="${s.id}Bar" class="bar-fill"></div></div>
            <div class="bar-controls">
                <button class="btn-big" onclick="alterarValor('${s.id}', -5)">-5</button>
                <button onclick="alterarValor('${s.id}', -1)">-1</button>
                <button onclick="alterarValor('${s.id}', 1)">+1</button>
                <button class="btn-big" onclick="alterarValor('${s.id}', 5)">+5</button>
                <input type="number" id="${s.id}MaxInput" onchange="setMax('${s.id}')">
                <span style="font-size:10px">MÁX</span>
            </div>
        </div>`;
    });
}

function alterarValor(tipo, qtd) {
    snapshot();
    ficha[tipo] += qtd;
    if(ficha[tipo] < 0) ficha[tipo] = 0;
    // Se for PV ou PE, respeita o limite máximo. Outros podem extrapolar.
    if((tipo === 'pv' || tipo === 'pe') && ficha[tipo] > ficha[tipo+'Max']) {
        ficha[tipo] = ficha[tipo+'Max'];
    }
    salvar();
}

function setMax(tipo) {
    snapshot();
    const val = parseInt(document.getElementById(tipo + 'MaxInput').value);
    ficha[tipo + 'Max'] = isNaN(val) ? 1 : val;
    salvar();
}

// Funções de Gerenciamento (Atributos, Poderes, etc - Mantidas)
function addAtributo() {
    const n = document.getElementById('attrNome').value.trim();
    const v = document.getElementById('attrValor').value;
    if(!n) return;
    if(ficha.atributos[n]) return alert("Já existe!");
    snapshot(); ficha.atributos[n] = v;
    document.getElementById('attrNome').value = ''; salvar();
}

function addHabilidade() {
    const n = document.getElementById('habNome').value.trim();
    const d = document.getElementById('habDesc').value;
    if(!n) return;
    snapshot(); ficha.habilidades.push({n, d});
    document.getElementById('habNome').value = ''; document.getElementById('habDesc').value = ''; salvar();
}

function addPenitencia() {
    const n = document.getElementById('penNome').value.trim();
    const lv = document.getElementById('penLV').value;
    const d = document.getElementById('penDesc').value;
    if(!n) return;
    snapshot(); ficha.penitencias.push({n, lv, d});
    document.getElementById('penNome').value = ''; document.getElementById('penDesc').value = ''; salvar();
}

function addArma() {
    const n = document.getElementById('armaNome').value;
    const d = document.getElementById('armaDano').value;
    if(!n) return;
    snapshot(); ficha.armas.push({n, d});
    document.getElementById('armaNome').value = ''; document.getElementById('armaDano').value = ''; salvar();
}

function removerItem(chave, i) {
    snapshot();
    if(chave === 'atributos') delete ficha.atributos[i];
    else ficha[chave].splice(i, 1);
    salvar();
}

function editarGenerico(chave, i, campo) {
    snapshot();
    let novo = prompt("Editar valor:", chave === 'atributos' ? ficha.atributos[i] : ficha[chave][i][campo]);
    if(novo !== null) {
        if(chave === 'atributos') ficha.atributos[i] = novo;
        else ficha[chave][i][campo] = novo;
        salvar();
    }
}

function desfazer() {
    if (historico.length > 0) {
        ficha = JSON.parse(historico.pop());
        render();
    }
}

function salvarSimples() {
    ficha.defesa = document.getElementById('armDef').value;
    ficha.historia = document.getElementById('historia').value;
    ficha.notas = document.getElementById('notas').value;
    localStorage.setItem('fichaRPG_V7', JSON.stringify(ficha));
}

function salvarHeader() {
    ficha.nome = document.getElementById('nome').value;
    ficha.idade = document.getElementById('idade').value;
    ficha.raca = document.getElementById('raca').value;
    ficha.classe = document.getElementById('classe').value;
    salvar();
}

function render(){
    statusConfig.forEach(s => {
        const perc = (ficha[s.id] / (ficha[s.id+'Max'] || 1)) * 100;
        document.getElementById(s.id+'Txt').textContent = `${ficha[s.id]} / ${ficha[s.id+'Max']}`;
        document.getElementById(s.id+'Bar').style.width = Math.min(100, Math.max(0, perc)) + '%';
        document.getElementById(s.id+'MaxInput').value = ficha[s.id+'Max'];
    });

    document.getElementById('nome').value = ficha.nome;
    document.getElementById('idade').value = ficha.idade;
    document.getElementById('raca').value = ficha.raca;
    document.getElementById('classe').value = ficha.classe;
    document.getElementById('armDef').value = ficha.defesa || 0;
    document.getElementById('historia').value = ficha.historia || '';
    document.getElementById('notas').value = ficha.notas || '';
    if(ficha.img) document.getElementById('imgChar').src = ficha.img;

    const renderLista = (id, lista, chave, htmlFunc) => {
        const el = document.getElementById(id);
        el.innerHTML = '';
        if(chave === 'atributos') {
            Object.keys(lista).forEach(k => el.innerHTML += htmlFunc(k, lista[k]));
        } else {
            lista.forEach((item, i) => el.innerHTML += htmlFunc(item, i));
        }
    };

    renderLista('listaAtributos', ficha.atributos, 'atributos', (k, v) => `<div class="list-item"><span onclick="editarGenerico('atributos', '${k}')"><b>${k}:</b> ${v}</span><button class="btn-delete" onclick="removerItem('atributos', '${k}')">X</button></div>`);
    renderLista('listaHabilidades', ficha.habilidades, 'habilidades', (item, i) => `<div class="list-item"><span onclick="editarGenerico('habilidades', ${i}, 'd')"><b>${item.n}</b><br><small>${item.d}</small></span><button class="btn-delete" onclick="removerItem('habilidades', ${i})">X</button></div>`);
    renderLista('listaArmas', ficha.armas, 'armas', (item, i) => `<div class="list-item"><span onclick="editarGenerico('armas', ${i}, 'd')"><b>${item.n}</b>: ${item.d}</span><button class="btn-delete" onclick="removerItem('armas', ${i})">X</button></div>`);
    renderLista('listaPenitencias', ficha.penitencias, 'penitencias', (item, i) => `<div class="list-item"><span onclick="editarGenerico('penitencias', ${i}, 'd')"><b>${item.n} (Nív. ${item.lv})</b><br><small>${item.d}</small></span><button class="btn-delete" onclick="removerItem('penitencias', ${i})">X</button></div>`);
}

function trocarImagem(){
    const u = prompt('URL da imagem'); 
    if(u) { snapshot(); ficha.img = u; document.getElementById('imgChar').src = u; salvar(); }
}

window.addEventListener('DOMContentLoaded', () => {
    renderStatus();
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            btn.classList.add('active');
            document.querySelector(`.section[data-sec='${btn.dataset.tab}']`).classList.add('active');
        });
    });
    const d = localStorage.getItem('fichaRPG_V7');
    if(d) {
        const saved = JSON.parse(d);
        ficha = {...ficha, ...saved};
    }
    render();
});
</script>
</body>
</html>
