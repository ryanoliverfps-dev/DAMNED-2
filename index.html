
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAMNED RPG - ONLINE GOLD</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --bg-body: #0a090d; --bg-header: #12101a; --bg-card: #1a1626; 
            --bg-input: #1f1a2e; --border-color: #3d2a5c; --accent-color: #a370ff; 
            --text-main: #ffffff; --text-dim: #b0a8c4; --text-input: #ffffff;
            --hp-color: #ff4444; --en-color: #4444ff; --ar-color: #cc44ff;
            --oc-color: #44ff44; --vi-color: #ffaa44; --co-color: #666666;
            --pet-gold: #ffd700;
        }
        
        [data-theme="light"] { --bg-body: #f5f5f5; --bg-header: #ffffff; --bg-card: #ffffff; --bg-input: #eee; --border-color: #ccc; --accent-color: #6200ee; --text-main: #111; --text-dim: #555; --text-input: #000; }
        [data-theme="vampire"] { --bg-body: #1a0505; --bg-header: #2d0a0a; --bg-card: #3d0f0f; --bg-input: #2d0a0a; --border-color: #8b0000; --accent-color: #ff0000; --text-main: #ffe0e0; --text-dim: #a07070; }

        body { margin:0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 90px; transition: 0.3s; }

        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 110000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center; }
        .auth-box { background: var(--bg-card); padding: 30px; border-radius: 20px; border: 1px solid var(--accent-color); width: 100%; max-width: 350px; box-shadow: 0 0 30px rgba(163, 112, 255, 0.2); }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; background: var(--bg-input); border: 1px solid var(--border-color); color: white; border-radius: 8px; box-sizing: border-box; }
        .btn-auth { width: 100%; padding: 12px; background: var(--accent-color); border: none; color: white; border-radius: 8px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 99999; }
        .loader-logo { width: 60px; height: 60px; border: 5px solid #333; border-top: 5px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: var(--bg-header); z-index: 10001; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-right: 3px solid var(--accent-color); padding: 25px; box-sizing: border-box; box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
        #sidebar.open { left: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; backdrop-filter: blur(4px); }
        #btn-menu-global { position: fixed; top: 15px; left: 15px; font-size: 22px; background: var(--bg-header); border: 2px solid var(--accent-color); border-radius: 12px; color: var(--accent-color); cursor: pointer; z-index: 9500; width: 48px; height: 48px; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        #menu-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.9)), url('https://files.catbox.moe/o5f62o.png') center/cover; z-index: 9000; padding: 20px; box-sizing: border-box; overflow-y: auto; text-align: center; display: none; }
        .char-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 30px 0; }
        .char-card { background: rgba(20, 20, 30, 0.9); border: 2px solid var(--border-color); border-radius: 15px; padding: 15px; transition: 0.3s; position: relative; }
        .char-card:active { transform: scale(0.95); border-color: var(--accent-color); }
        .char-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--accent-color); }

        #criacao-personagem { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 100000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .criacao-box { background: var(--bg-card); padding: 30px; border-radius: 20px; border: 1px solid var(--accent-color); width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .criacao-box input, .criacao-box select, .criacao-box textarea { width: 100%; padding: 12px; margin-bottom: 15px; background: var(--bg-input); border: 1px solid var(--border-color); color: white; border-radius: 8px; box-sizing: border-box; }
        .criacao-box select option { background: var(--bg-card); color: white; }
        .classe-descricao { background: var(--bg-input); padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 12px; color: var(--text-dim); border-left: 3px solid var(--accent-color); }

        header { display:flex; gap:15px; padding: 20px; background: var(--bg-header); border-bottom: 3px solid var(--accent-color); }
        #imgChar { width: 110px; height: 150px; object-fit: cover; border-radius: 12px; border: 2px solid var(--accent-color); box-shadow: 0 0 15px rgba(163, 112, 255, 0.3); }
        .header-fields { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .header-fields input { background: var(--bg-input); border: 1px solid var(--border-color); color: #fff; padding: 8px; border-radius: 6px; font-size: 13px; }

        .tabs-wrapper { overflow-x: auto; background: var(--bg-header); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .tabs { display: flex; white-space: nowrap; padding: 5px; }
        .tab-btn { padding: 12px 20px; background: none; border: none; color: var(--text-dim); font-weight: bold; font-size: 12px; text-transform: uppercase; cursor: pointer; }
        .tab-btn.active { color: var(--accent-color); border-bottom: 3px solid var(--accent-color); }

        .section { display: none; padding: 20px; animation: slideUp 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .status-container { display: grid; gap: 15px; }
        .bar-card { background: var(--bg-card); padding: 15px; border-radius: 15px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .bar-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 14px; }
        .bar-outer { height: 16px; background: #000; border-radius: 8px; overflow: hidden; border: 1px solid #333; margin-bottom: 12px; }
        .bar-inner { height: 100%; transition: 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        .bar-btns { display: grid; grid-template-columns: repeat(4, 1fr) 60px; gap: 6px; }
        .bar-btns button { padding: 10px 0; border: none; border-radius: 6px; background: #2a243d; color: #fff; font-weight: bold; font-size: 12px; touch-action: manipulation; cursor: pointer; }
        .bar-btns button:active { background: var(--accent-color); }
        .max-input { background: #000; border: 1px solid var(--border-color); color: var(--accent-color); text-align: center; border-radius: 6px; font-weight: bold; }

        .atributo-linha, .pericia-linha { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color); }
        .atributo-nome, .pericia-nome { font-weight: bold; color: var(--accent-color); min-width: 120px; }
        .atributo-valor, .pericia-valor { font-size: 18px; font-weight: bold; min-width: 50px; text-align: center; }
        .atributo-botoes, .pericia-botoes { display: flex; gap: 5px; }
        .atributo-botoes button, .pericia-botoes button { width: 40px; height: 40px; border: none; background: var(--bg-input); color: white; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; border: 1px solid var(--border-color); }
        .atributo-botoes button:active, .pericia-botoes button:active { background: var(--accent-color); }

        .classe-bonus { background: linear-gradient(90deg, var(--accent-color)22, transparent); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid var(--accent-color); }
        .classe-desc-box { background: var(--bg-input); padding: 15px; border-radius: 8px; margin-top: 20px; }

        .add-box { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px dashed var(--accent-color); margin-bottom: 20px; }
        .card-item { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 5px solid var(--accent-color); position: relative; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .card-item h4 { margin: 0 0 5px 0; color: var(--accent-color); font-size: 16px; cursor: pointer; }
        .card-item p { margin: 0; font-size: 13px; color: var(--text-dim); line-height: 1.4; cursor: pointer; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.1); color: #ff4444; border: 1px solid #ff4444; border-radius: 5px; padding: 4px 8px; font-size: 10px; cursor: pointer; }

        .pet-card { border-left-color: var(--pet-gold); background: linear-gradient(90deg, rgba(255,215,0,0.05) 0%, var(--bg-card) 100%); border-right: 1px solid rgba(255,215,0,0.2); }
        .pet-meta { display: flex; gap: 12px; align-items: center; margin-bottom: 15px; }
        .pet-img { width: 70px; height: 70px; border-radius: 15px; border: 2px solid var(--pet-gold); object-fit: cover; }
        .pet-bar-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 11px; font-weight: bold; color: var(--pet-gold); }
        .pet-grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .pet-stat-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #444; font-size: 12px; }

        .footer { position: fixed; bottom: 0; width: 100%; background: var(--bg-header); padding: 15px; display: flex; gap: 10px; border-top: 2px solid var(--accent-color); box-sizing: border-box; }
        .footer button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-weight: bold; color: #fff; cursor: pointer; }
        .btn-undo { background: #333; }
        .btn-redo { background: #444; }

        .btn-add-main { width: 100%; padding: 12px; background: var(--accent-color); color: #fff; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border-color); color: #fff; border-radius: 6px; padding: 10px; box-sizing: border-box; resize: vertical; }
        input, select { background: var(--bg-input); border: 1px solid var(--border-color); color: #fff; padding: 10px; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body data-theme="dark">

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--accent-color); margin-bottom:25px;">DAMNED LOGIN</h2>
        <input type="email" id="login-email" class="auth-input" placeholder="Seu E-mail">
        <input type="password" id="login-senha" class="auth-input" placeholder="Sua Senha">
        <button class="btn-auth" onclick="fazerLogin()">ACESSAR FICHA</button>
        <button class="btn-auth" style="background:transparent; border:1px solid var(--accent-color);" onclick="criarConta()">CRIAR NOVA CONTA</button>
        <p id="auth-msg" style="color:#ff4444; font-size:12px; margin-top:10px;"></p>
    </div>
</div>

<div id="criacao-personagem">
    <div class="criacao-box">
        <h2 style="color:var(--accent-color); margin-bottom:20px;">CRIAR NOVO PERSONAGEM</h2>
        <input type="text" id="criacao-nome" placeholder="Nome do Personagem">
        <input type="number" id="criacao-idade" placeholder="Idade">
        <select id="criacao-classe">
            <option value="">Selecione uma Classe</option>
        </select>
        <div id="classe-descricao" class="classe-descricao"></div>
        <textarea id="criacao-historia" placeholder="HistÃ³ria do Personagem..." rows="4"></textarea>
        <textarea id="criacao-traumas" placeholder="Traumas..." rows="3"></textarea>
        <div style="display:flex; gap:10px;">
            <button class="btn-auth" style="flex:1;" onclick="confirmarCriacao()">CRIAR</button>
            <button class="btn-auth" style="flex:1; background:transparent;" onclick="fecharCriacao()">CANCELAR</button>
        </div>
    </div>
</div>

<div id="loading-screen"><div class="loader-logo"></div><p style="color:white; margin-top:15px; font-size:12px; letter-spacing:2px;">SINCRONIZANDO NUVEM...</p></div>

<button id="btn-menu-global" onclick="toggleSidebar()">â˜°</button>

<div id="sidebar">
    <h2 style="color: var(--accent-color); margin-bottom:30px;">MENU GOLD</h2>
    <div style="padding: 18px 0; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="cycleTheme()">ðŸŒ“ Alternar Tema</div>
    <div style="padding: 18px 0; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="exportarFicha()">ðŸ“¥ Exportar Ficha (.json)</div>
    <div style="padding: 18px 0; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="importarFicha()">ðŸ“¤ Importar Ficha</div>
    <div style="padding: 18px 0; color: #ff4444; cursor: pointer; margin-top: 20px;" onclick="abrirMenu()">ðŸšª Lista de Fichas</div>
    <div style="padding: 18px 0; color: #ff4444; cursor: pointer;" onclick="fazerLogout()">ðŸ”Œ Sair da Conta</div>
    <div style="position: absolute; bottom: 20px; font-size: 10px; color: var(--text-dim);">V32.9 ONLINE - DAMNED RPG</div>
</div>
<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

<div id="menu-screen">
    <h1 style="color:#fff; margin-top:60px; font-size: 32px; text-shadow: 0 0 15px var(--accent-color);">DAMNED RPG</h1>
    <p id="user-display" style="color: var(--text-dim); margin-bottom: 40px;">Sincronizado</p>
    <button onclick="abrirCriacao()" style="width:100%; padding:20px; background:var(--accent-color); color:#fff; border:none; border-radius:15px; font-weight:bold; font-size:16px; box-shadow: 0 5px 15px rgba(0,0,0,0.4);">+ CRIAR NOVA FICHA</button>
    <div id="lista-personagens" class="char-grid"></div>
</div>

<div id="sheet-content" style="display:none;">
    <header>
        <img id="imgChar" onclick="triggerImg()" src="https://via.placeholder.com/110x150">
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadImagem(event)">
        <div class="header-fields">
            <input id="nome" placeholder="Nome do Personagem" onchange="salvarHeader()">
            <div style="display:flex; gap:5px;">
                <input id="idade" placeholder="Idade" style="width:40%" onchange="salvarHeader()">
                <input id="raca" placeholder="RaÃ§a" style="flex:1" onchange="salvarHeader()">
            </div>
            <input id="classe" placeholder="Classe / OcupaÃ§Ã£o" onchange="salvarHeader()">
        </div>
    </header>

    <div class="tabs-wrapper">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 0)">Status</button>
            <button class="tab-btn" onclick="switchTab(event, 1)">Atributos</button>
            <button class="tab-btn" onclick="switchTab(event, 2)">PerÃ­cias</button>
            <button class="tab-btn" onclick="switchTab(event, 3)">Poderes</button>
            <button class="tab-btn" onclick="switchTab(event, 4)">Arsenal</button>
            <button class="tab-btn" onclick="switchTab(event, 5)">Defesa</button>
            <button class="tab-btn" onclick="switchTab(event, 6)">Itens</button>
            <button class="tab-btn" onclick="switchTab(event, 7)">PenitÃªncia</button>
            <button class="tab-btn" onclick="switchTab(event, 8)">DiÃ¡rio</button>
            <button class="tab-btn" onclick="switchTab(event, 9)">Familiares</button>
        </div>
    </div>

    <div class="section active" id="sec-0">
        <div id="classe-bonus" class="classe-bonus"></div>
        <div id="status-bars-container" class="status-container"></div>
        <div id="classe-descricao-status" class="classe-desc-box"></div>
    </div>

    <div class="section" id="sec-1">
        <div class="classe-bonus" id="atributos-bonus"></div>
        <div id="lista-atributos"></div>
    </div>

    <div class="section" id="sec-2">
        <div class="classe-bonus" id="pericias-bonus"></div>
        <div id="lista-pericias"></div>
    </div>

    <div class="section" id="sec-3">
        <div class="add-box">
            <input id="pdN" placeholder="Nome do Poder">
            <textarea id="pdD" placeholder="DescriÃ§Ã£o completa do efeito..." rows="3"></textarea>
            <button class="btn-add-main" onclick="addItem('habilidades',['pdN','pdD'],['n','d'])">ADICIONAR PODER</button>
        </div>
        <div id="listaPd"></div>
    </div>

    <div class="section" id="sec-4">
        <div class="add-box">
            <input id="arN" placeholder="Nome da Arma">
            <input id="arDan" placeholder="Dano (ex: 2d10 + 5)">
            <textarea id="arD" placeholder="Efeitos especiais..." rows="2"></textarea>
            <button class="btn-add-main" onclick="addItem('armas',['arN','arDan','arD'],['n','dan','d'])">ADICIONAR AO ARSENAL</button>
        </div>
        <div id="listaAr"></div>
    </div>

    <div class="section" id="sec-5">
        <div style="background:var(--accent-color); color:white; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px; box-shadow:0 10px 20px rgba(0,0,0,0.3);">
            <div style="font-size:12px; opacity:0.8; text-transform:uppercase;">Defesa Total Estimada</div>
            <div id="defTotal" style="font-size:42px; font-weight:900;">0</div>
        </div>
        <div class="add-box">
            <input id="eqN" placeholder="Equipamento">
            <input id="eqV" type="number" placeholder="Defesa">
            <button class="btn-add-main" onclick="addItem('equipamentos',['eqN','eqV'],['n','v'])">EQUIPAR</button>
        </div>
        <div id="listaEq"></div>
    </div>

    <div class="section" id="sec-6">
        <div class="add-box">
            <div style="display:flex; gap:10px;">
                <input id="invN" placeholder="Item" style="flex:1">
                <input id="invQ" placeholder="Qtd" style="width:70px">
            </div>
            <textarea id="invD" placeholder="DescriÃ§Ã£o..." rows="2"></textarea>
            <button class="btn-add-main" onclick="addItem('inventario',['invN','invQ','invD'],['n','q','d'])">GUARDAR ITEM</button>
        </div>
        <div id="listaInv"></div>
    </div>

    <div class="section" id="sec-7">
        <div class="add-box">
            <input id="peN" placeholder="Nome da PenitÃªncia">
            <textarea id="peD" placeholder="DescriÃ§Ã£o..." rows="3"></textarea>
            <button class="btn-add-main" onclick="addItem('penitencias',['peN','peD'],['n','d'])">ADICIONAR PENITÃŠNCIA</button>
        </div>
        <div id="listaPe"></div>
    </div>

    <div class="section" id="sec-8">
        <h3 style="color:var(--accent-color)">HistÃ³ria</h3>
        <textarea id="historia" style="height:200px;" onchange="salvarDiario()"></textarea>
        <h3 style="color:var(--accent-color); margin-top:20px;">Notas</h3>
        <textarea id="anotacoes" style="height:300px;" onchange="salvarDiario()"></textarea>
    </div>

    <div class="section" id="sec-9">
        <div class="add-box">
            <div style="text-align:center; margin-bottom:15px;">
                <img id="petPreview" src="https://via.placeholder.com/80" style="width:80px; height:80px; border-radius:15px; border:2px solid var(--pet-gold); object-fit:cover; display:none; margin: 0 auto 10px;">
                <button onclick="document.getElementById('petImgInput').click()" style="background:#333; color:white; border:1px solid var(--pet-gold); padding:8px 15px; border-radius:20px; font-size:11px; cursor:pointer;">ðŸ“· CARREGAR FOTO</button>
                <input type="file" id="petImgInput" accept="image/*" style="display:none" onchange="previewPet(event)">
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px;">
                <input id="petN" placeholder="Nome do Familiar">
                <input id="petLvl" placeholder="NÃ­vel">
            </div>
            <div class="pet-grid-stats" style="grid-template-columns: 1fr 1fr 1fr;">
                <input id="petV" placeholder="HP Max" type="number">
                <input id="petDef" placeholder="DEF">
                <input id="petAtk" placeholder="ATK">
            </div>
            <textarea id="petD" placeholder="Habilidades e Notas..." style="margin-top:10px;"></textarea>
            <button class="btn-add-main" style="background:var(--pet-gold); color:#000;" onclick="addPetFull()">VINCULAR FAMILIAR</button>
        </div>
        <div id="listaPets"></div>
        <div id="vinculo-barra" class="bar-card" style="margin-top:20px;">
            <div class="bar-label"><span>VÃ­nculo com Familiares</span><span id="vinculo-valor">0 / 10</span></div>
            <div class="bar-outer"><div id="vinculo-barra-inner" class="bar-inner" style="width:0%; background:var(--vi-color);"></div></div>
            <div class="bar-btns">
                <button onclick="modVinculo(-5)">-5</button>
                <button onclick="modVinculo(-1)">-1</button>
                <button onclick="modVinculo(1)">+1</button>
                <button onclick="modVinculo(5)">+5</button>
                <input type="number" id="vinculo-max" class="max-input" value="10" onchange="setVinculoMax(this.value)">
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn-undo" onclick="desfazer()">â†© VOLTAR</button>
        <button class="btn-redo" onclick="refazer()">AVANÃ‡AR â†ª</button>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCffwVZ3zoM0GJNIcMdebDPXogfKq_bp-w",
  authDomain: "damned-rpg.firebaseapp.com",
  databaseURL: "https://damned-rpg-default-rtdb.firebaseio.com",
  projectId: "damned-rpg",
  storageBucket: "damned-rpg.firebasestorage.app",
  messagingSenderId: "753626576411",
  appId: "1:753626576411:web:0b100a3f64b9d9fec8eabe"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const rtdb = firebase.database();
let userUID = null;
let db = [];
let cur = -1; 
let ficha = {}; 
let undo = []; 
let redo = [];
let tempPetImg = "";

// Listas predefinidas
const atributosBase = ['ForÃ§a', 'Agilidade', 'Destreza', 'InteligÃªncia', 'Sabedoria', 'Carisma', 'ConstituiÃ§Ã£o', 'Vigor'];
const periciasBase = [
    'SobrevivÃªncia', 'Crime', 'Conhecimento', 'Furtividade', 'Carisma',
    'Fortitude', 'TÃ¡tica', 'PercepÃ§Ã£o', 'Ocultismo', 'Magia',
    'IntimidaÃ§Ã£o', 'Iniciativa', 'Pontaria', 'ConstituiÃ§Ã£o', 'Combate', 'InvestigaÃ§Ã£o'
];

// PerÃ­cias especÃ­ficas por classe
const periciasClasse = {
    'Barbaro': ['Combate', 'Fortitude', 'IntimidaÃ§Ã£o', 'SobrevivÃªncia', 'Iniciativa'],
    'Paladino': ['Combate', 'Carisma', 'Fortitude', 'IntimidaÃ§Ã£o', 'TÃ¡tica'],
    'Lutador': ['Combate', 'Fortitude', 'IntimidaÃ§Ã£o', 'TÃ¡tica', 'Iniciativa'],
    'Samurai': ['Combate', 'TÃ¡tica', 'PercepÃ§Ã£o', 'Iniciativa', 'Fortitude'],
    'Monge': ['Combate', 'Fortitude', 'PercepÃ§Ã£o', 'Iniciativa', 'Furtividade'],
    'Ranged': ['Pontaria', 'PercepÃ§Ã£o', 'Furtividade', 'SobrevivÃªncia', 'Iniciativa'],
    'Ladino': ['Furtividade', 'Crime', 'PercepÃ§Ã£o', 'Iniciativa', 'Pontaria'],
    'Ninja': ['Furtividade', 'Combate', 'PercepÃ§Ã£o', 'Iniciativa', 'Crime'],
    'Ocultista': ['Ocultismo', 'Magia', 'Conhecimento', 'PercepÃ§Ã£o', 'InvestigaÃ§Ã£o'],
    'Mago': ['Magia', 'Conhecimento', 'Ocultismo', 'InvestigaÃ§Ã£o', 'PercepÃ§Ã£o'],
    'Feiticeiro': ['Magia', 'Carisma', 'PercepÃ§Ã£o', 'Iniciativa', 'Ocultismo'],
    'Bruxa': ['Ocultismo', 'Magia', 'Conhecimento', 'PercepÃ§Ã£o', 'IntimidaÃ§Ã£o'],
    'ClÃ©rigo': ['Ocultismo', 'Magia', 'Carisma', 'Fortitude', 'InvestigaÃ§Ã£o'],
    'Druida': ['SobrevivÃªncia', 'Magia', 'PercepÃ§Ã£o', 'Fortitude', 'Conhecimento'],
    'Nobre': ['Carisma', 'Conhecimento', 'IntimidaÃ§Ã£o', 'InvestigaÃ§Ã£o', 'TÃ¡tica'],
    'Artifice': ['Conhecimento', 'PercepÃ§Ã£o', 'InvestigaÃ§Ã£o', 'Pontaria', 'TÃ¡tica'],
    'Bardo': ['Carisma', 'Conhecimento', 'PercepÃ§Ã£o', 'Furtividade', 'IntimidaÃ§Ã£o']
};

// Todas as classes com seus atributos, PV, PE, vantagens e desvantagens
const classeBonus = {
    'Barbaro': { 
        pv: 100, pe: 20, 
        atributos: { 'ForÃ§a': 3, 'ConstituiÃ§Ã£o': 2, 'InteligÃªncia': -1 },
        descricao: 'ðŸ¹ **BÃ¡rbaro** - Guerreiros das terras selvagens que canalizam a fÃºria interior.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ FÃºria: Aumenta dano e resistÃªncia drasticamente\n' +
                   'â€¢ Instinto de SobrevivÃªncia: BÃ´nus em situaÃ§Ãµes de perigo\n' +
                   'â€¢ ResistÃªncia Natural: ReduÃ§Ã£o de dano fÃ­sico\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ -1 de InteligÃªncia\n' +
                   'â€¢ Dificuldade em controle emocional\n' +
                   'â€¢ VulnerÃ¡vel a manipulaÃ§Ã£o mental'
    },
    'Paladino': { 
        pv: 90, pe: 40, 
        atributos: { 'ForÃ§a': 2, 'Carisma': 2, 'ConstituiÃ§Ã£o': 1 },
        descricao: 'âš”ï¸ **Paladino** - Guerreiros sagrados que juram proteÃ§Ã£o aos inocentes.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Aura Protetora: Aliados prÃ³ximos ganham resistÃªncia\n' +
                   'â€¢ Cura Divina: Pode curar ferimentos graves\n' +
                   'â€¢ Julgamento: Dano extra contra criaturas das trevas\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ CÃ³digo de conduta rigoroso\n' +
                   'â€¢ Perde poderes se violar o juramento\n' +
                   'â€¢ Intolerante com atos malignos'
    },
    'Lutador': { 
        pv: 85, pe: 45, 
        atributos: { 'ForÃ§a': 2, 'ConstituiÃ§Ã£o': 2, 'Destreza': 1 },
        descricao: 'ðŸ‘Š **Lutador** - Mestres do combate corpo a corpo sem armas.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Golpes Poderosos: Ataques desarmados causam dano elevado\n' +
                   'â€¢ MÃºltiplos Ataques: Pode atacar vÃ¡rias vezes por rodada\n' +
                   'â€¢ ImobilizaÃ§Ã£o: TÃ©cnicas de submissÃ£o\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Alcance limitado\n' +
                   'â€¢ VulnerÃ¡vel a ataques Ã  distÃ¢ncia\n' +
                   'â€¢ Dependente de proximidade'
    },
    'Samurai': { 
        pv: 80, pe: 80, 
        atributos: { 'Destreza': 2, 'Sabedoria': 2, 'ForÃ§a': 1 },
        descricao: 'ðŸ—¡ï¸ **Samurai** - Seguem o bushido e sÃ£o mestres da espada.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Ataques Precisos: CrÃ­ticos melhorados\n' +
                   'â€¢ Foco em Combate: BÃ´nus em duelos\n' +
                   'â€¢ Corte RÃ¡pido: Ataques de oportunidade\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ CÃ³digo de honra pode ser explorado\n' +
                   'â€¢ Vergonha afeta performance\n' +
                   'â€¢ Obrigado a aceitar desafios'
    },
    'Monge': { 
        pv: 75, pe: 65, 
        atributos: { 'Sabedoria': 2, 'Destreza': 2, 'ConstituiÃ§Ã£o': 1 },
        descricao: 'ðŸ§˜ **Monge** - Canalizam energia interior (ki) para aperfeiÃ§oar corpo e mente.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Ataques Desarmados Poderosos\n' +
                   'â€¢ Defesa Elevada sem armaduras\n' +
                   'â€¢ Mobilidade Superior\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ NÃ£o usam armaduras\n' +
                   'â€¢ Dependente de ki\n' +
                   'â€¢ RestriÃ§Ãµes alimentares/espirituais'
    },
    'Ranged': { 
        pv: 70, pe: 50, 
        atributos: { 'Destreza': 3, 'Sabedoria': 2 },
        descricao: 'ðŸ¹ **Ranged** - Especialistas em combate Ã  distÃ¢ncia.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Pontaria Letal: +3 em ataques Ã  distÃ¢ncia\n' +
                   'â€¢ Tiros Precisos: Ignora cobertura parcial\n' +
                   'â€¢ Mira RÃ¡pida: MÃºltiplos disparos\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Fraco em combate corpo a corpo\n' +
                   'â€¢ Dependente de muniÃ§Ã£o\n' +
                   'â€¢ Penalidade em espaÃ§os confinados'
    },
    'Ladino': { 
        pv: 65, pe: 60, 
        atributos: { 'Destreza': 3, 'Carisma': 1, 'InteligÃªncia': 1 },
        descricao: 'ðŸ—ï¸ **Ladino** - Especialistas em furtividade e ataques furtivos.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Ataques Furtivos: Dano massivo em alvos desprevenidos\n' +
                   'â€¢ PercepÃ§Ã£o AguÃ§ada: Dificilmente surpreendido\n' +
                   'â€¢ Habilidades de Crime: Abrir fechaduras, desarmar armadilhas\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Combate direto limitado\n' +
                   'â€¢ ReputaÃ§Ã£o questionÃ¡vel\n' +
                   'â€¢ Depende do elemento surpresa'
    },
    'Ninja': { 
        pv: 60, pe: 75, 
        atributos: { 'Destreza': 3, 'Sabedoria': 1, 'ConstituiÃ§Ã£o': 1 },
        descricao: 'ðŸ¥· **Ninja** - Assassinos sombrios treinados em subterfÃºgio.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Furtividade Extrema: Quase invisÃ­vel quando escondido\n' +
                   'â€¢ Venenos: Especialista em toxinas\n' +
                   'â€¢ ProjÃ©teis: Shurikens e ferramentas de ninja\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ CÃ³digo de honra prÃ³prio\n' +
                   'â€¢ VulnerÃ¡vel quando descoberto\n' +
                   'â€¢ ReputaÃ§Ã£o de traidor'
    },
    'Ocultista': { 
        pv: 55, pe: 100, 
        atributos: { 'Sabedoria': 3, 'InteligÃªncia': 2, 'Carisma': -1 },
        descricao: 'ðŸ”® **Ocultista** - Estudam conhecimentos proibidos e entidades cÃ³smicas.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Magia de Sangue: Rituais poderosos\n' +
                   'â€¢ InvocaÃ§Ãµes: Pode chamar criaturas de outras dimensÃµes\n' +
                   'â€¢ Conhecimento Proibido: InformaÃ§Ãµes que outros nÃ£o tÃªm\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Risco de insanidade\n' +
                   'â€¢ -1 de Carisma\n' +
                   'â€¢ Perseguido por autoridades religiosas'
    },
    'Mago': { 
        pv: 50, pe: 95, 
        atributos: { 'InteligÃªncia': 4, 'Sabedoria': 1, 'ForÃ§a': -2 },
        descricao: 'ðŸ“š **Mago** - Estudiosos das artes arcanas.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Magia Poderosa: Acesso a todos os feitiÃ§os\n' +
                   'â€¢ Conhecimento EnciclopÃ©dico\n' +
                   'â€¢ Versatilidade MÃ¡gica\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ -2 de ForÃ§a\n' +
                   'â€¢ Fisicamente frÃ¡gil\n' +
                   'â€¢ Dependente de grimÃ³rios'
    },
    'Feiticeiro': { 
        pv: 60, pe: 85, 
        atributos: { 'Carisma': 3, 'ConstituiÃ§Ã£o': 2, 'Sabedoria': -1 },
        descricao: 'âœ¨ **Feiticeiro** - Magia inata no sangue.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Magia Intuitiva: Conjura sem preparo\n' +
                   'â€¢ Metamagia: Modifica feitiÃ§os em tempo real\n' +
                   'â€¢ Linhagem MÃ¡gica: BÃ´nus em escola especÃ­fica\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ -1 de Sabedoria\n' +
                   'â€¢ Limitado a poucos feitiÃ§os\n' +
                   'â€¢ Impulsivo'
    },
    'Bruxa': { 
        pv: 60, pe: 80, 
        atributos: { 'InteligÃªncia': 2, 'Sabedoria': 2, 'Carisma': 1 },
        descricao: 'ðŸ§™ **Bruxa** - Manipulam forÃ§as ancestrais da natureza.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ ConexÃ£o com EspÃ­ritos: Aliados sobrenaturais\n' +
                   'â€¢ PoÃ§Ãµes e FeitiÃ§os Naturais\n' +
                   'â€¢ MaldiÃ§Ãµes Poderosas\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ VulnerÃ¡veis a ferro\n' +
                   'â€¢ -1 de ConstituiÃ§Ã£o\n' +
                   'â€¢ CaÃ§adas por fanÃ¡ticos'
    },
    'ClÃ©rigo': { 
        pv: 80, pe: 60, 
        atributos: { 'Sabedoria': 3, 'ConstituiÃ§Ã£o': 1, 'ForÃ§a': 1 },
        descricao: 'â›ª **ClÃ©rigo** - Canalizam poder divino.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Cura em dobro\n' +
                   'â€¢ ResistÃªncia a Necromancia\n' +
                   'â€¢ ProteÃ§Ã£o Divina\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Limitado por dogmas religiosos\n' +
                   'â€¢ Deve seguir os preceitos da divindade\n' +
                   'â€¢ Conflito com outras religiÃµes'
    },
    'Druida': { 
        pv: 75, pe: 70, 
        atributos: { 'Sabedoria': 3, 'ConstituiÃ§Ã£o': 2 },
        descricao: 'ðŸŒ³ **Druida** - Protetores da natureza.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Formas Animais: TransformaÃ§Ã£o em bestas\n' +
                   'â€¢ ComunicaÃ§Ã£o com criaturas\n' +
                   'â€¢ Magia Natural\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ NÃ£o usam metal\n' +
                   'â€¢ RestriÃ§Ãµes naturais\n' +
                   'â€¢ Conflito com civilizaÃ§Ã£o'
    },
    'Nobre': { 
        pv: 70, pe: 60, 
        atributos: { 'Carisma': 4, 'InteligÃªncia': 1 },
        descricao: 'ðŸ‘‘ **Nobre** - Usam influÃªncia e recursos.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ Riqueza: Acesso a recursos financeiros\n' +
                   'â€¢ Contatos: Aliados poderosos\n' +
                   'â€¢ LideranÃ§a: Comando em grupo\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Inexperiente em combate\n' +
                   'â€¢ Alvo de inveja e conspiraÃ§Ãµes\n' +
                   'â€¢ ObrigaÃ§Ãµes polÃ­ticas'
    },
    'Artifice': { 
        pv: 70, pe: 65, 
        atributos: { 'InteligÃªncia': 3, 'Destreza': 2 },
        descricao: 'ðŸ”§ **ArtÃ­fice** - Criadores de itens mÃ¡gicos.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ CriaÃ§Ã£o de Itens: FabricaÃ§Ã£o de equipamentos\n' +
                   'â€¢ InfusÃµes MÃ¡gicas: Itens temporariamente encantados\n' +
                   'â€¢ Engenhocas: Dispositivos Ãºteis\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Dependente de ferramentas\n' +
                   'â€¢ Tempo para criar itens\n' +
                   'â€¢ Materiais caros'
    },
    'Bardo': { 
        pv: 65, pe: 75, 
        atributos: { 'Carisma': 3, 'Destreza': 2 },
        descricao: 'ðŸŽ­ **Bardo** - Artistas que inspiram e confundem.\n\n' +
                   'âœ¨ **Vantagens:**\n' +
                   'â€¢ InspiraÃ§Ã£o: Buffs em grupo\n' +
                   'â€¢ Versatilidade: Um pouco de tudo\n' +
                   'â€¢ PersuasÃ£o: Influencia multidÃµes\n\n' +
                   'âš ï¸ **Desvantagens:**\n' +
                   'â€¢ Combate direto limitado\n' +
                   'â€¢ Dependente de plateia\n' +
                   'â€¢ ReputaÃ§Ã£o instÃ¡vel'
    }
};

// Preencher o select de classes automaticamente
window.onload = function() {
    const select = document.getElementById('criacao-classe');
    Object.keys(classeBonus).sort().forEach(classe => {
        const option = document.createElement('option');
        option.value = classe;
        option.textContent = classe;
        select.appendChild(option);
    });
};

// VariÃ¡veis para repetiÃ§Ã£o automÃ¡tica (Clique Longo)
let intervalId = null;
let timeoutId = null;

auth.onAuthStateChanged(user => {
    if (user) {
        userUID = user.uid;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'flex';
        document.getElementById('user-display').innerText = "Logado como: " + user.email;
        carregarFichasOnline();
    } else {
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('sheet-content').style.display = 'none';
        document.getElementById('btn-menu-global').style.display = 'none';
    }
});

function criarConta() {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    if(!email || !senha) return alert("Preencha tudo!");
    auth.createUserWithEmailAndPassword(email, senha)
        .catch(error => document.getElementById('auth-msg').innerText = error.message);
}

function fazerLogin() {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    auth.signInWithEmailAndPassword(email, senha)
        .catch(error => document.getElementById('auth-msg').innerText = "Erro: Email ou senha incorretos.");
}

function fazerLogout() { if(confirm("Deseja sair da conta?")) auth.signOut(); }

function carregarFichasOnline() {
    rtdb.ref('users/' + userUID + '/fichas').once('value', (snapshot) => {
        db = snapshot.val() || [];
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            abrirMenu();
        }, 800);
    });
}

function salvarNoBanco() {
    if (cur !== -1) db[cur] = JSON.parse(JSON.stringify(ficha));
    if (userUID) {
        localStorage.setItem('RPG_GOLD_V32', JSON.stringify(db));
        rtdb.ref('users/' + userUID + '/fichas').set(db);
    }
}

function abrirMenu() {
    cur = -1; 
    document.getElementById('sheet-content').style.display = 'none';
    document.getElementById('btn-menu-global').style.display = 'none';
    document.getElementById('menu-screen').style.display = 'block';
    renderListaMenu();
}

function abrirCriacao() {
    document.getElementById('criacao-personagem').style.display = 'flex';
    document.getElementById('classe-descricao').innerHTML = '';
}

function fecharCriacao() {
    document.getElementById('criacao-personagem').style.display = 'none';
}

function confirmarCriacao() {
    const nome = document.getElementById('criacao-nome').value;
    const idade = document.getElementById('criacao-idade').value;
    const classe = document.getElementById('criacao-classe').value;
    const historia = document.getElementById('criacao-historia').value;
    const traumas = document.getElementById('criacao-traumas').value;

    if (!nome || !classe) {
        alert('Preencha pelo menos nome e classe!');
        return;
    }

    const bonus = classeBonus[classe] || { pv: 50, pe: 50, atributos: {}, descricao: '' };
    const periciasClasseAtual = periciasClasse[classe] || [];
    
    const novo = {
        nome: nome,
        idade: idade,
        raca: '',
        classe: classe,
        img: '',
        pv: bonus.pv,
        pvMax: bonus.pv,
        pe: bonus.pe,
        peMax: bonus.pe,
        sanidade: 50,
        sanidadeMax: 100,
        arc: 0,
        arcMax: 100,
        ocu: 0,
        ocuMax: 100,
        vinculo: 0,
        vinculoMax: 100,
        corr: 0,
        corrMax: 100,
        atributos: {},
        pericias: {},
        habilidades: [],
        armas: [],
        equipamentos: [],
        inventario: [],
        penitencias: traumas ? [{ n: 'Traumas', d: traumas }] : [],
        historia: historia,
        anotacoes: '',
        pets: []
    };

    // Inicializar atributos com valores base (0) e aplicar bÃ´nus
    atributosBase.forEach(attr => {
        novo.atributos[attr] = 0;
    });
    
    // Aplicar bÃ´nus da classe
    Object.entries(bonus.atributos).forEach(([attr, bonus]) => {
        if (novo.atributos.hasOwnProperty(attr)) {
            novo.atributos[attr] = bonus;
        }
    });

    // Inicializar perÃ­cias com 0 e aplicar bÃ´nus de classe (+2 nas perÃ­cias principais)
    periciasBase.forEach(per => {
        novo.pericias[per] = 0;
    });
    
    // Dar +2 nas perÃ­cias principais da classe
    periciasClasseAtual.forEach(per => {
        if (novo.pericias.hasOwnProperty(per)) {
            novo.pericias[per] = 2;
        }
    });

    db.push(novo);
    salvarNoBanco();
    fecharCriacao();
    renderListaMenu();
}

function renderListaMenu() {
    const l = document.getElementById('lista-personagens'); l.innerHTML = '';
    db.forEach((c, i) => {
        l.innerHTML += `
            <div class="char-card" onclick="selecionar(${i})">
                <img src="${c.img || 'https://via.placeholder.com/150'}">
                <b style="display:block; margin-bottom:5px;">${c.nome}</b>
                <span style="font-size:10px; color:var(--text-dim)">${c.classe || 'Sem Classe'}</span>
                <button onclick="event.stopPropagation(); apagar(${i})" style="position:absolute; top:-10px; right:-10px; background:#ff4444; border:none; color:white; border-radius:50%; width:25px; height:25px;">Ã—</button>
            </div>`;
    });
}

function selecionar(i) {
    cur = i; 
    ficha = JSON.parse(JSON.stringify(db[i]));
    
    // SEGURANÃ‡A: Garante que listas novas existam em fichas antigas
    if(!ficha.inventario) ficha.inventario = [];
    if(!ficha.penitencias) ficha.penitencias = [];
    if(!ficha.habilidades) ficha.habilidades = [];
    if(!ficha.armas) ficha.armas = [];
    if(!ficha.equipamentos) ficha.equipamentos = [];
    if(!ficha.pets) ficha.pets = [];
    if(!ficha.atributos) ficha.atributos = {};
    if(!ficha.pericias) ficha.pericias = {};
    if(!ficha.sanidade) ficha.sanidade = 50;
    if(!ficha.sanidadeMax) ficha.sanidadeMax = 100;
    if(!ficha.vinculo) ficha.vinculo = 0;
    if(!ficha.vinculoMax) ficha.vinculoMax = 100;

    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('btn-menu-global').style.display = 'flex';
    document.getElementById('sheet-content').style.display = 'block';
    renderFicha();
}

function cycleTheme() {
    const themes = ['dark', 'light', 'vampire'];
    let current = document.body.getAttribute('data-theme');
    let next = themes[(themes.indexOf(current) + 1) % themes.length];
    document.body.setAttribute('data-theme', next);
    localStorage.setItem('GOLD_THEME', next);
}

function toggleSidebar() {
    const s = document.getElementById('sidebar'), o = document.getElementById('overlay');
    const open = s.classList.toggle('open');
    o.style.display = open ? 'block' : 'none';
}

function switchTab(e, idx) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    e.target.classList.add('active');
    document.getElementById(`sec-${idx}`).classList.add('active');
    window.scrollTo(0,0);
}

function apagar(i) { if(confirm("Deseja apagar esta lenda?")) { db.splice(i, 1); salvarNoBanco(); renderListaMenu(); } }
function snap() { undo.push(JSON.stringify(ficha)); redo = []; if(undo.length > 30) undo.shift(); }
function triggerImg() { document.getElementById('fileInput').click(); }
function uploadImagem(e) {
    const reader = new FileReader();
    reader.onload = (ev) => { snap(); ficha.img = ev.target.result; renderFicha(); };
    reader.readAsDataURL(e.target.files[0]);
}
function previewPet(e) {
    const reader = new FileReader();
    reader.onload = (ev) => { tempPetImg = ev.target.result; document.getElementById('petPreview').src = tempPetImg; document.getElementById('petPreview').style.display = 'block'; };
    reader.readAsDataURL(e.target.files[0]);
}

function editar(caminho, idx, campo, rotulo) {
    let atual = (caminho === 'at') ? ((campo === 'n') ? idx : ficha.atributos[idx]) : 
                 (caminho === 'per') ? ((campo === 'n') ? idx : ficha.pericias[idx]) :
                 ficha[caminho][idx][campo];
    let novo = prompt(`Editar ${rotulo}:`, atual);
    if(novo !== null) {
        snap();
        if(caminho === 'at') {
            if(campo === 'n') { let val = ficha.atributos[idx]; delete ficha.atributos[idx]; ficha.atributos[novo] = val; }
            else ficha.atributos[idx] = parseInt(novo) || 0;
        } else if(caminho === 'per') {
            if(campo === 'n') { let val = ficha.pericias[idx]; delete ficha.pericias[idx]; ficha.pericias[novo] = val; }
            else ficha.pericias[idx] = parseInt(novo) || 0;
        } else { ficha[caminho][idx][campo] = novo; }
        renderFicha();
    }
}

function modVal(attr, qtd) { snap(); ficha[attr] = Math.min(ficha[attr+'Max'] || 100, Math.max(0, (parseInt(ficha[attr]) || 0) + qtd)); renderFicha(); }
function setMax(attr, val) { snap(); ficha[attr+'Max'] = Math.min(100, Math.max(1, parseInt(val) || 1)); renderFicha(); }
function modVinculo(qtd) { snap(); ficha.vinculo = Math.min(ficha.vinculoMax || 100, Math.max(0, (parseInt(ficha.vinculo) || 0) + qtd)); renderFicha(); }
function setVinculoMax(val) { snap(); ficha.vinculoMax = Math.min(100, Math.max(1, parseInt(val) || 1)); renderFicha(); }
function modPetHp(idx, qtd) { snap(); let p = ficha.pets[idx]; p.v = Math.min(p.vmax, Math.max(0, (parseInt(p.v) || 0) + qtd)); renderFicha(); }
function setPetMaxHp(idx, val) { snap(); ficha.pets[idx].vmax = Math.min(100, Math.max(1, parseInt(val) || 1)); renderFicha(); }

function modAtributo(attr, qtd) {
    snap();
    if(!ficha.atributos[attr]) ficha.atributos[attr] = 0;
    ficha.atributos[attr] = Math.max(0, (parseInt(ficha.atributos[attr]) || 0) + qtd);
    renderFicha();
}

function modPericia(per, qtd) {
    snap();
    if(!ficha.pericias[per]) ficha.pericias[per] = 0;
    ficha.pericias[per] = Math.max(0, (parseInt(ficha.pericias[per]) || 0) + qtd);
    renderFicha();
}

// --- LÃ“GICA DE CLIQUE LONGO ---
function startAutoMod(attr, qtd, isPet = false, petIdx = null) {
    if (isPet) modPetHp(petIdx, qtd);
    else modVal(attr, qtd);

    timeoutId = setTimeout(() => {
        intervalId = setInterval(() => {
            if (isPet) modPetHp(petIdx, qtd);
            else modVal(attr, qtd);
        }, 80); 
    }, 500);
}

function stopAutoMod() {
    clearTimeout(timeoutId);
    clearInterval(intervalId);
}

function startAutoModAtributo(attr, qtd) {
    modAtributo(attr, qtd);
    timeoutId = setTimeout(() => {
        intervalId = setInterval(() => {
            modAtributo(attr, qtd);
        }, 80);
    }, 500);
}

function startAutoModPericia(per, qtd) {
    modPericia(per, qtd);
    timeoutId = setTimeout(() => {
        intervalId = setInterval(() => {
            modPericia(per, qtd);
        }, 80);
    }, 500);
}
// -----------------------------

function addItem(key, ids, props) {
    const vals = ids.map(id => document.getElementById(id).value);
    
    if(!vals[0]) return; 

    if(!ficha[key]) ficha[key] = [];

    snap();
    let obj = {}; 
    props.forEach((p, i) => obj[p] = vals[i]);
    
    ficha[key].push(obj); 
    
    ids.forEach(id => document.getElementById(id).value = '');
    
    renderFicha();
}

function addPetFull() {
    const n = document.getElementById('petN').value; if(!n) return;
    snap();
    let max = document.getElementById('petV').value || 10;
    ficha.pets.push({
        n: n, img: tempPetImg, v: max, vmax: max, lvl: document.getElementById('petLvl').value || '1',
        def: document.getElementById('petDef').value, atk: document.getElementById('petAtk').value, d: document.getElementById('petD').value
    });
    tempPetImg = ""; 
    document.getElementById('petPreview').style.display = 'none';
    document.getElementById('petN').value = '';
    document.getElementById('petV').value = '';
    document.getElementById('petLvl').value = '';
    document.getElementById('petDef').value = '';
    document.getElementById('petAtk').value = '';
    document.getElementById('petD').value = '';
    renderFicha();
}

function remover(key, idx) { snap(); if(key === 'at') delete ficha.atributos[idx]; else if(key === 'per') delete ficha.pericias[idx]; else ficha[key].splice(idx, 1); renderFicha(); }
function salvarHeader() { ficha.nome = document.getElementById('nome').value; ficha.idade = document.getElementById('idade').value; ficha.raca = document.getElementById('raca').value; ficha.classe = document.getElementById('classe').value; salvarNoBanco(); }
function salvarDiario() { ficha.historia = document.getElementById('historia').value; ficha.anotacoes = document.getElementById('anotacoes').value; salvarNoBanco(); }

function renderFicha() {
    document.getElementById('nome').value = ficha.nome || '';
    document.getElementById('idade').value = ficha.idade || '';
    document.getElementById('raca').value = ficha.raca || '';
    document.getElementById('classe').value = ficha.classe || '';
    document.getElementById('imgChar').src = ficha.img || 'https://via.placeholder.com/110x150';

    // Renderizar bÃ´nus da classe
    const classeAtual = ficha.classe;
    const bonus = classeBonus[classeAtual] || null;
    const periciasClasseAtual = periciasClasse[classeAtual] || [];
    const classeBonusEl = document.getElementById('classe-bonus');
    const classeDescEl = document.getElementById('classe-descricao-status');
    const atributosBonusEl = document.getElementById('atributos-bonus');
    const periciasBonusEl = document.getElementById('pericias-bonus');

    if (bonus) {
        const bonusTexto = Object.entries(bonus.atributos)
            .map(([a,b]) => `${a} ${b > 0 ? '+' : ''}${b}`)
            .join(' Â· ');
        classeBonusEl.innerHTML = `<strong style="color:var(--accent-color);">${classeAtual}</strong> - PV: ${bonus.pv} | PE: ${bonus.pe} | ${bonusTexto}`;
        classeDescEl.innerHTML = `<strong>DescriÃ§Ã£o da Classe:</strong><br>${bonus.descricao.replace(/\n/g, '<br>')}`;
        atributosBonusEl.innerHTML = `<strong>BÃ´nus de Atributos:</strong> ${bonusTexto}`;
        
        // Mostrar perÃ­cias da classe
        const periciasTexto = periciasClasseAtual.join(' Â· ');
        periciasBonusEl.innerHTML = `<strong>PerÃ­cias Treinadas:</strong> ${periciasTexto} (recebem +2)`;
    } else {
        classeBonusEl.innerHTML = '';
        classeDescEl.innerHTML = '';
        atributosBonusEl.innerHTML = '';
        periciasBonusEl.innerHTML = '';
    }

    // Barras de status
    const sCont = document.getElementById('status-bars-container');
    sCont.innerHTML = '';
    const stats = [
        {id:'pv', n:'Pontos de Vida', c:'var(--hp-color)'},
        {id:'pe', n:'Energia / Mana', c:'var(--en-color)'},
        {id:'sanidade', n:'Sanidade', c:'var(--oc-color)'},
        {id:'arc', n:'NÃ­vel Arcano', c:'var(--ar-color)'},
        {id:'ocu', n:'Ocultismo', c:'var(--oc-color)'},
        {id:'vinculo', n:'VÃ­nculo', c:'var(--vi-color)'},
        {id:'corr', n:'CorrupÃ§Ã£o', c:'var(--co-color)'}
    ];

    stats.forEach(s => {
        let curV = parseInt(ficha[s.id]) || 0; 
        let maxV = parseInt(ficha[s.id+'Max']) || 100;
        let perc = Math.min(100, (curV / maxV) * 100);
        sCont.innerHTML += `<div class="bar-card">
            <div class="bar-label"><span>${s.n}</span><span>${curV} / ${maxV}</span></div>
            <div class="bar-outer"><div class="bar-inner" style="width:${perc}%; background:${s.c}; box-shadow: 0 0 10px ${s.c}66;"></div></div>
            <div class="bar-btns">
                <button onpointerdown="startAutoMod('${s.id}',-5)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">-5</button>
                <button onpointerdown="startAutoMod('${s.id}',-1)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">-1</button>
                <button onpointerdown="startAutoMod('${s.id}',1)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">+1</button>
                <button onpointerdown="startAutoMod('${s.id}',5)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">+5</button>
                <input type="number" class="max-input" value="${maxV}" onchange="setMax('${s.id}', this.value)" max="100">
            </div>
        </div>`;
    });

    // Renderizar Atributos
    const atList = document.getElementById('lista-atributos');
    atList.innerHTML = '';
    atributosBase.forEach(attr => {
        let valor = ficha.atributos[attr] || 0;
        atList.innerHTML += `
            <div class="atributo-linha">
                <span class="atributo-nome">${attr}</span>
                <span class="atributo-valor">${valor}</span>
                <div class="atributo-botoes">
                    <button onpointerdown="startAutoModAtributo('${attr}',-1)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">-</button>
                    <button onpointerdown="startAutoModAtributo('${attr}',1)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">+</button>
                </div>
            </div>
        `;
    });

    // Renderizar PerÃ­cias (destacar as da classe)
    const perList = document.getElementById('lista-pericias');
    perList.innerHTML = '';
    periciasBase.forEach(per => {
        let valor = ficha.pericias[per] || 0;
        let isClassePer = periciasClasse[classeAtual]?.includes(per);
        perList.innerHTML += `
            <div class="pericia-linha" style="${isClassePer ? 'border-left: 3px solid var(--accent-color);' : ''}">
                <span class="pericia-nome">${per} ${isClassePer ? 'â­' : ''}</span>
                <span class="pericia-valor">${valor}</span>
                <div class="pericia-botoes">
                    <button onpointerdown="startAutoModPericia('${per}',-1)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">-</button>
                    <button onpointerdown="startAutoModPericia('${per}',1)" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">+</button>
                </div>
            </div>
        `;
    });

    // Atualizar barra de vÃ­nculo
    document.getElementById('vinculo-valor').innerText = `${ficha.vinculo || 0} / ${ficha.vinculoMax || 100}`;
    document.getElementById('vinculo-barra-inner').style.width = `${Math.min(100, ((ficha.vinculo || 0) / (ficha.vinculoMax || 100)) * 100)}%`;
    document.getElementById('vinculo-max').value = ficha.vinculoMax || 100;
    document.getElementById('vinculo-max').max = 100;

    renderGeneric('listaPd', ficha.habilidades, 'h', (it, i) => `<div class="card-item"><button class="btn-delete" onclick="remover('habilidades',${i})">X</button><h4 onclick="editar('habilidades',${i},'n','Poder')">${it.n}</h4><p onclick="editar('habilidades',${i},'d','DescriÃ§Ã£o')">${it.d}</p></div>`);
    renderGeneric('listaAr', ficha.armas, 'a', (it, i) => `<div class="card-item"><button class="btn-delete" onclick="remover('armas',${i})">X</button><h4 onclick="editar('armas',${i},'n','Arma')">${it.n}</h4><p onclick="editar('armas',${i},'dan','Dano')">Dano: ${it.dan}</p><p onclick="editar('armas',${i},'d','Efeito')">${it.d}</p></div>`);
    renderGeneric('listaInv', ficha.inventario, 'inv', (it, i) => `<div class="card-item"><button class="btn-delete" onclick="remover('inventario',${i})">X</button><h4 onclick="editar('inventario',${i},'n','Item')">${it.n} (x${it.q})</h4><p onclick="editar('inventario',${i},'d','DescriÃ§Ã£o')">${it.d}</p></div>`);
    renderGeneric('listaPe', ficha.penitencias, 'p', (it, i) => `<div class="card-item"><button class="btn-delete" onclick="remover('penitencias',${i})">X</button><h4 onclick="editar('penitencias',${i},'n','PenitÃªncia')">${it.n}</h4><p onclick="editar('penitencias',${i},'d','DescriÃ§Ã£o')">${it.d}</p></div>`);
    
    renderGeneric('listaPets', ficha.pets, 'pet', (it, i) => {
        let curV = parseInt(it.v) || 0; let maxV = parseInt(it.vmax) || 10;
        let perc = Math.min(100, (curV / maxV) * 100);
        return `<div class="card-item pet-card">
            <button class="btn-delete" onclick="remover('pets',${i})">X</button>
            <div class="pet-meta"><img src="${it.img || 'https://via.placeholder.com/70'}" class="pet-img"><div><h4 onclick="editar('pets',${i},'n','Nome')">${it.n}</h4><span style="font-size:10px; color:var(--pet-gold)">NÃ­vel: <b onclick="editar('pets',${i},'lvl','NÃ­vel')">${it.lvl}</b></span></div></div>
            <div class="pet-bar-label"><span>HP DO FAMILIAR</span><span>${curV} / ${maxV}</span></div>
            <div class="bar-outer"><div class="bar-inner" style="width:${perc}%; background:var(--pet-gold);"></div></div>
            <div class="bar-btns">
                <button onpointerdown="startAutoMod(null,-1, true, ${i})" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">-1</button>
                <button onpointerdown="startAutoMod(null,1, true, ${i})" onpointerup="stopAutoMod()" onpointerleave="stopAutoMod()">+1</button>
                <input type="number" class="max-input" value="${maxV}" onchange="setPetMaxHp(${i}, this.value)" max="100">
            </div>
            <div class="pet-grid-stats"><div class="pet-stat-box" onclick="editar('pets',${i},'def','DEF')">ðŸ›¡ï¸ DEF: ${it.def}</div><div class="pet-stat-box" onclick="editar('pets',${i},'atk','ATK')">âš”ï¸ ATK: ${it.atk}</div></div>
            <p style="margin-top:8px; font-size:11px;" onclick="editar('pets',${i},'d','DescriÃ§Ã£o')">${it.d || ''}</p>
        </div>`});

    let totalDef = 0;
    renderGeneric('listaEq', ficha.equipamentos, 'e', (it, i) => {
        totalDef += (parseInt(it.v) || 0);
        return `<div class="card-item"><button class="btn-delete" onclick="remover('equipamentos',${i})">X</button><h4>${it.n}</h4><p>Defesa: +${it.v}</p></div>`;
    });
    document.getElementById('defTotal').innerText = totalDef;
    
    // Atualizar campos de texto
    document.getElementById('historia').value = ficha.historia || '';
    document.getElementById('anotacoes').value = ficha.anotacoes || '';
    
    salvarNoBanco();
}

function renderGeneric(id, data, type, temp) {
    const el = document.getElementById(id); 
    if (!el) return;
    el.innerHTML = '';
    if(!data) return;
    if(type === 'at') Object.keys(data).forEach(k => el.innerHTML += temp(k, data[k]));
    else if(type === 'per') Object.keys(data).forEach(k => el.innerHTML += temp(k, data[k]));
    else data.forEach((item, i) => el.innerHTML += temp(item, i));
}

function desfazer() { if(undo.length > 0) { redo.push(JSON.stringify(ficha)); ficha = JSON.parse(undo.pop()); renderFicha(); } }
function refazer() { if(redo.length > 0) { undo.push(JSON.stringify(ficha)); ficha = JSON.parse(redo.pop()); renderFicha(); } }
function exportarFicha() { const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(ficha)); const a = document.createElement('a'); a.href = data; a.download = (ficha.nome || 'ficha') + ".json"; a.click(); }
function importarFicha() { const input = document.createElement('input'); input.type = 'file'; input.onchange = e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = ev => { snap(); ficha = JSON.parse(ev.target.result); renderFicha(); }; reader.readAsText(file); }; input.click(); }

// Atualizar descriÃ§Ã£o da classe na criaÃ§Ã£o
document.getElementById('criacao-classe').addEventListener('change', function(e) {
    const classe = e.target.value;
    if (classe && classeBonus[classe]) {
        const bonus = classeBonus[classe];
        const periciasLista = periciasClasse[classe] || [];
        const bonusTexto = Object.entries(bonus.atributos)
            .map(([a,b]) => `${a} ${b > 0 ? '+' : ''}${b}`)
            .join(', ');
        const periciasTexto = periciasLista.join(', ');
        document.getElementById('classe-descricao').innerHTML = 
            `<strong>${classe}</strong><br>
             <span style="color:var(--hp-color);">PV: ${bonus.pv}</span> | <span style="color:var(--en-color);">PE: ${bonus.pe}</span><br>
             <strong>Atributos:</strong> ${bonusTexto}<br>
             <strong>PerÃ­cias Treinadas:</strong> ${periciasTexto} (recebem +2)<br><br>
             ${bonus.descricao.replace(/\n/g, '<br>')}`;
    } else {
        document.getElementById('classe-descricao').innerHTML = '';
    }
});
</script>
</body>
</html>
